---
title: "Manipulating Data in R"
author: "John Muschelli"
date: "January 4, 2016"
output:
  ioslides_presentation:
    css: ../../styles.css
  beamer_presentation: default
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(comment = "")
```

## Overview

In this module, we will show you how to:

1. Perform operations by a grouping variable
2. Reshaping data from long (tall) to wide (fat)
3. Reshaping data from wide (fat) to long (tall)

## Setup

We will show you how to do each operation in base R then show you how to use the `dplyr` or `tidyr` package to do the same operation (if applicable).  

See the "Data Wrangling Cheat Sheet using `dplyr` and `tidyr`":
* https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf

## Load the packages/libraries

```{r}
library(dplyr)
library(tidyr)
```

## Data used: Charm City Circulator

Let's read in the Charm City Circulator data:

```{r}
# nasa is included in `dplyr` - converting to a data.frame
ex_data = read.csv("../../data/Charm_City_Circulator_Ridership.csv", 
                   as.is = TRUE)
library(lubridate) # great for dates!
ex_data = mutate(ex_data, date = dmy(date))
head(ex_data, 2)
```

## Making column names a little more separated

We will use `str_replace` from `stringr` to put periods in the column names.
```{r}
library(stringr)
cn = colnames(ex_data)
cn = cn %>% 
  str_replace("Board", ".Board") %>% 
  str_replace("Alight", ".Alight") %>% 
  str_replace("Average", ".Average") 
colnames(ex_data) = cn
```


## Removing the daily ridership

We want to look at each ridership, and will removet the `daily` column:
```{r}
ex_data$daily = NULL
```

# Reshaping data from wide (fat) to long (tall)

# Resources

See http://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/


## Reshaping data from wide (fat) to long (tall): base R

The `reshape` command exists.  It is a **confusing** function.  Don't use it.

## Reshaping data from wide (fat) to long (tall): tidyr

In `tidyr`, the `gather` function gathers columns into rows.

We want the column names into "`type`" variable in the output dataset and the value in "`number`" variable
```{r}
long = gather(ex_data, "var", "number", 
              starts_with("orange"),
              starts_with("purple"), starts_with("green"),
              starts_with("banner"))
head(long)
table(long$var)
```

## Reshaping data from wide (fat) to long (tall): tidyr

Now each `var` is boardings, averages, or alightings.  We want to separate these so we can have these by line.

```{r}
long = separate_(long, "var", into = c("line", "type"), sep = "[.]")
head(long)
table(long$line)
table(long$type)
```

# Reshaping data from long (tall) to wide (fat)

## Reshaping data from long (tall) to wide (fat): tidyr

In `tidyr`, the `spread` function spreads rows into columns.  Now we have a long data set, but we want to separate the Average, Alightings and Boardings into different columns

```{r}
wide = spread(long, key = type)
```




# Perform Operations By Groups of Variables

## Perform Operations By Groups: base R

The `tapply` command will take in a vector (`X`), perform a function
(`FUN`) over an index (`INDEX`):

```{r}
args(tapply)
```

## Perform Operations By Groups: base R

The `tapply` command will take in a vector (`X`), perform a function
(`FUN`) over an index (`INDEX`):

```{r}
args(tapply)
```


## Perform Operations By Groups: base R

Let's get the mean temperature by year:
```{r}
tapply(ex_data$temperature, ex_data$year, mean)
```

## Perform Operations By Groups: dplyr

Let's get the mean temperature by year.  We will use `group_by` to group the data by temperature, then use `summarize` (or `summarise`) to get the mean temperature:
```{r}
gb = group_by(ex_data, year)
summarize(gb, mean_temp = mean(temperature))
```

## Perform Operations By Groups: dplyr with piping

Using piping, this is:

```{r}
ex_data %>% 
  group_by(year) %>%
  summarise(mean_temp = mean(temperature))
```


## Perform Operations By Multiple Groups: dplyr 

This can easily be extended using `group_by` with multiple groups:

```{r}
ex_data %>% 
  group_by(year, month) %>%
  summarise(mean_temp = mean(temperature))
```

## Perform Operations By Multiple Groups: dplyr 

This can easily be extended using `group_by` with multiple groups:

```{r}
ex_data %>% 
  group_by(year, month) %>%
  summarise(mean_temp = mean(temperature))
```
